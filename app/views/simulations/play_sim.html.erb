Budget :- <span id="user_budget"> <%= @simulation_user_data.budget %> </span>

<%= nested_form_for @simulation do |f| %>


    <%= f.fields_for :user_sim_datums do |user_sim_data| %>

        <%= user_sim_data.hidden_field :user_id, :value => current_user.id %>

        <label>Select Programme</label>
        <%#= user_sim_data.select :simulation_datum_id, @simulation_data.map { |u| ["#{u.programme_name} - #{u.start_time.strftime("%T")}", u.id] }, { include_blank: false }, { class: 'chosen-select'} %>
        <%= user_sim_data.select :simulation_datum_id, @simulation_data.map { |u| ["#{u.programme_name} - #{u.start_time.strftime("%T")}", u.id] }, { include_blank: false }, { class: 'chosen-select' , :onchange => 'get_cost($(this))' }%>

        <%= f.label :no_of_slots %>:
        <%= user_sim_data.text_field :no_of_slots, {:onkeyup=>"calculate_budget($(this))", :onfocus=>"get_my_dropdown_val($(this))"} %>
        <%#= user_sim_data.text_field :no_of_slots, {:onfocus=>"get_my_dropdown_val($(this))"} %>

        <%#= @simulation_data.map { |u| "#{u.cost_per_slot}" }%>

        <%= user_sim_data.link_to_remove "Remove this task" %>
    <% end %>
    <p><%= f.link_to_add "Add a task", :user_sim_datums %></p>

    <%= f.submit "Submit", :class => "btn" %>
<% end %>

<script>
    var user_budget_manipulated, user_budget_real;
    var simulation_id = <%= @simulation.id %>
    var cost_per_slot;
    $(function(){

      //user_budget = $("#user_budget").text();
      user_budget_manipulated = <%= @simulation_user_data.budget %>
      user_budget_real = <%= @simulation_user_data.budget %>



//      $(".chosen-select").chosen().change(function(event){
//
//          if(event.target == this){
//
//              var this_selected_val = $(this).val();
//              //console.log("this_selected_val :- " + this_selected_val)
//
//              var data = {simulation_id:[], simulation_data_id: []};
//              data["simulation_id"].push(simulation_id);
//              data["simulation_data_id"].push(this_selected_val);
//              $.ajax({
//                  url: "/get_cost",
//                  type: "post",
//                  async: false,
//                  data: JSON.stringify(data),
//                  contentType: "application/json",
//                  success: function (data) {
//                      console.log(data[0].cost_per_slot);
//                      cost_per_slot = data[0].cost_per_slot;
//                      console.log("cost_per_slot :- " + cost_per_slot)
//                  }
//              })
//          }
//      });

  });

  function get_cost(this_obj){
    var this_val = $(this_obj).val();
    console.log("this_val :- " + this_val);

      var data = {simulation_id:[], simulation_data_id: []};
      data["simulation_id"].push(simulation_id);
      data["simulation_data_id"].push(this_val);
      $.ajax({
          url: "/get_cost",
          type: "post",
          async: false,
          data: JSON.stringify(data),
          contentType: "application/json",
          success: function (data) {
              console.log(data[0].cost_per_slot);
              cost_per_slot = data[0].cost_per_slot;
              console.log("cost_per_slot :- " + cost_per_slot)
          }
      })
  }

  function calculate_budget(this_obj){

      var this_val = $(this_obj).val();
      console.log("this_val :- " + this_val);
      console.log("user_budget_manipulated :- " + user_budget_manipulated);
      console.log("cost_per_slot :- " + cost_per_slot);

      if (event.keyCode == 8 || event.keyCode == 46) {
          if (this_val==""){
              console.log("blank");
              user_budget_manipulated = user_budget_real;
          }
          else{
              console.log("backspace or delete :- " + this_val);
              user_budget_manipulated = user_budget_real - (this_val*cost_per_slot);
          }
      }
      else{
          user_budget_manipulated = user_budget_manipulated - (this_val*cost_per_slot);
      }
      console.log("user_budget_manipulated :- " + user_budget_manipulated);

      $("#user_budget").text(user_budget_manipulated);

  }

  function get_my_dropdown_val(this_obj){
      var this_dropdown_val = $(this_obj).parent().find('.chosen-select option:selected').val();
      console.log("this_dropdown_val :- " + this_dropdown_val)
  }

  $('form').on('nested:fieldAdded', function(event) {
      $(event.target).find('.chosen-select').chosen();
  });

</script>